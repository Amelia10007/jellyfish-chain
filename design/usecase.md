# ユースケース
## 単語
- トランザクション  
  台帳に保存する情報の単位
- ブロック  
  ヘッダとデータを詰め込んだもの。  
  ヘッダはブロックの高さやタイムスタンプ、ハッシュなどのメタデータを含む。  
  データは新規トランザクション追加、修正、削除要求のリスト
- チェックポイントブロック  
  特別なブロックで、新規トランザクションのみをデータに含む。つまりトランザクション修正、削除要求はない
- チェーン  
  ハッシュを使ったブロックの時系列
- 台帳  
  ネットワーク上のノードの役割。チェーンを保存する
- クライアント  
  ネットワーク上のノードの役割。トランザクションを作成してネットワークに広報したり、ネットワークからトランザクションを取得する
- マイナー  
  ネットワーク上のノードの役割。次のブロックを作成するための情報を探索する

## クライアントのユースケース
### アカウント作成
1. クライアントはアカウント情報を作成する
1. クライアントはアカウント情報を保存する
### トランザクション登録
1. クライアントは自分のアカウント情報を読み込む
1. クライアントはトランザクションを作成する
1. クライアントはネットワークにトランザクションを広報する
1. クライアントはネットワークから要求に対する返答を受け取る
### トランザクション参照
1. クライアントはトランザクションの検索条件を作る
1. クライアントはネットワークにトランザクション参照要求を出す
1. クライアントは台帳から返答を受信する
1. 返答を表示する
### トランザクション修正
1. クライアントは自分のアカウント情報を読み込む
1. クライアントは修正対象のトランザクション番号を決める
1. クライアントは修正後のトランザクションを作成する
1. クライアントはネットワークにトランザクション修正要求を広報する
1. クライアントはネットワークから要求に対する返答を受け取る
### トランザクション削除
1. クライアントは自分のアカウント情報を読み込む
1. クライアントは削除対象のトランザクション番号を決める
1. クライアントはネットワークにトランザクション削除要求を広報する
1. クライアントはネットワークから要求に対する返答を受け取る

## 台帳のユースケース
### トランザクション返答
1. 台帳はクライアントからのトランザクション参照要求を受信する
1. 台帳は参照要求で指定された検索条件に該当するトランザクションをローカルから検索する
1. 該当トランザクションがあればそのトランザクションをクライアントに返答する
1. 該当トランザクションが存在しなければ何もしない
### トランザクション受取
1. 台帳はクライアントからトランザクションを受け取る
1. 台帳は受け取ったトランザクションを検証する
1. トランザクションに問題がなければ、それを未承認要求のリストに追加し、クライアントに受取通知を返答する
1. トランザクションに問題があれば、そのトランザクションを破棄し、クライアントに拒否通知を返答する
### トランザクション修正要求受取
1. 台帳はクライアントからトランザクション修正要求を受け取る
1. 台帳は修正対象のトランザクションが承認済ブロックに存在するか検証する
1. 台帳は修正要求の正当性を検証する
1. 検証に問題がなければ、台帳は修正要求を未承認要求のリストに追加し、クライアントに受取通知を返答する
1. 検証に問題があれば、台帳はその要求を破棄し、クライアントに拒否通知を返答する
### トランザクション削除要求受取
1. 台帳はクライアントからトランザクション削除要求を受け取る
1. 台帳は削除対象のトランザクションが承認済ブロックに存在するか検証する
1. 台帳は削除要求の正当性を検証する
1. 検証に問題がなければ、台帳は削除要求を未承認要求のリストに追加し、クライアントに受取通知を返答する
1. 検証に問題があれば、台帳はその要求を破棄し、クライアントに拒否通知を返答する
### ブロック作成
1. 台帳はローカルから未承認要求(トランザクション追加、修正、削除)のリストを読み込む
1. 台帳はローカルから前ブロックのハッシュを読み込む
1. 台帳は未承認要求のうち、ブロックに追加する要求を選ぶ。不適切な要求は破棄する
1. 台帳は未承認要求のmarkle treeを作成する
1. 台帳はmarkle rootのハッシュと前ブロックのハッシュ、採掘難易度を詰めたハッシュ探索要請をマイナーに送信する
1. 台帳はマイナーからのハッシュ計算結果を取得する
1. 台帳は受信したハッシュを検証し、問題があれば破棄する。有効なハッシュであれば以下を実施する
1. 台帳はマイナーにハッシュ探索終了通知を送信する
1. 台帳はブロックを作成し、保存する
1. 台帳はブロックに含めたすべての未承認要求を、未承認要求リストから削除する
### チェックポイントブロック作成
1. 台帳はローカルから、以前のチェックポイントブロックのコピーと、それ以降に承認したブロックを取得する
1. 台帳はチェックポイントブロックのコピーに保存してあるトランザクションに対して、それ以降に承認したブロックに含まれるトランザクション追加/修正/削除を適用する
1. 台帳は更新されたチェックポイントブロックのコピーに含まれるトランザクションのmarkle treeを作成する
1. 台帳はmarkle rootのハッシュと前ブロックのハッシュ、採掘難易度を詰めたハッシュ探索要請をマイナーに送信する
1. 台帳はマイナーからのハッシュ計算結果を取得する
1. 台帳は受信したハッシュを検証し、問題があれば破棄する。有効なハッシュであれば以下を実施する
1. 台帳はマイナーにハッシュ探索終了通知を送信する
1. 台帳はチェックポイントブロックを作成し、保存する
1. 台帳は2つ前以前のチェックポイントブロックを削除する
### ブロックヘッダ広報
1. 台帳は自分が保持する最新のブロックのヘッダをネットワークに広報する
### ブロックデータ要求
1. 台帳はネットワークからブロックヘッダを受け取る
1. 台帳はブロックヘッダに含まれるブロック高さとmarkle rootを参照する。該当ブロックをすでに保持している場合は何もしない。それ以外の場合は下記を実施する
1. 台帳はネットワークに該当ブロックのデータを要求する
1. 台帳はネットワークから該当ブロックのデータを受信する
1. 該当ブロックのデータを検証し、問題なければブロックを復元する
1. 該当ブロックに含まれている前ブロックのハッシュを読み込み、該当ブロックを保持していれば、復元ブロックを追加する。
1. チェックポイントブロックを受け取った場合は、２つ前以前のチェックポイントブロックを削除する
### ブロックデータ返答
1. 台帳はネットワークからブロックデータ要求を受信する
1. 台帳は該当ブロックがあり、かつ該当位置のトランザクションがあれば、そのトランザクションを返答する

## マイナーのユースケース
### ハッシュ探索依頼の受託
1. マイナーはネットワークからハッシュ探索依頼を受信する
1. マイナーはハッシュを探索する
1. マイナーはハッシュを見つけた場合、そのハッシュをネットワークに返答する
### ハッシュ探索終了通知の受取
1. マイナーはネットワークからハッシュ探索終了通知を受信する
1. マイナーはハッシュ探索中の場合、探索要求を送信してきたアカウントと同一アカウントが終了通知を送ってきたのか検証する
1. 検証をパスした場合、マイナーはハッシュ探索を終了する
